<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HellCube | Server</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #5865F2;
      --primary-dark: #4752C4;
      --background: #36393F;
      --background-light: #40444B;
      --text: #F6F6F6;
      --text-muted: #B9BBBE;
      --accent: #57F287;
      --accent-dark: #3BA55C;
      --danger: #ED4245;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      padding: 2rem;
      overflow-x: hidden;
      animation: fadeIn 1s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .server-container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--background-light);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: fadeIn 1s ease;
    }

    .banner {
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
      animation: fadeIn 1.2s ease;
    }

    .logo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 5px solid var(--background-light);
      position: absolute;
      bottom: -50px;
      left: 30px;
      background-size: cover;
      background-position: center;
      animation: fadeIn 1.3s ease;
    }

    .content {
      padding: 4rem 2rem 2rem;
      animation: fadeIn 1.4s ease;
    }

    .title {
      font-size: 2rem;
      font-weight: 600;
    }

    .members {
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .description {
      margin: 1rem 0;
      line-height: 1.6;
      color: var(--text);
    }

    .tags {
      margin-bottom: 1.5rem;
    }

    .tag {
      background: var(--primary);
      color: white;
      padding: 0.3rem 1rem;
      border-radius: 30px;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      display: inline-block;
    }

    .buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .button {
      background: var(--accent);
      padding: 0.7rem 1.5rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .button:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }

    .button.danger {
      background: var(--danger);
    }

    .comments {
      margin-top: 2rem;
    }

    .comment-box textarea {
      width: 100%;
      padding: 0.8rem;
      border-radius: 10px;
      border: none;
      resize: vertical;
      margin-bottom: 1rem;
      background: var(--background);
      color: white;
    }

    .comment {
      background: var(--background);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      animation: fadeIn 0.3s ease;
    }

    .comment .meta {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      padding: 0.7rem 1.5rem;
      border-radius: 10px;
      color: var(--background);
      font-weight: bold;
      animation: fadeIn 0.3s ease;
      z-index: 9999;
    }

.mention-dropdown {
  position: absolute;
  background: var(--background-light);
  border: 1px solid var(--primary);
  border-radius: 6px;
  padding: 6px;
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
  display: none;
}

.mention-dropdown div {
  padding: 5px 10px;
  cursor: pointer;
  transition: background 0.2s;
}

.mention-dropdown div:hover {
  background: var(--primary-dark);
}

.mention {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
}

    
  </style>
</head>
<body>
  <div class="server-container" id="server"></div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const client = supabase.createClient("https://dsosdqwmeydiyrbzcojz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzb3NkcXdtZXlkaXlyYnpjb2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMTY1NDUsImV4cCI6MjA2Nzc5MjU0NX0.9om86eGS68cqtBexnK5f6RKJF1_eeXEnPtSKu1BTOek");
    const serverContainer = document.getElementById("server");

    const showToast = (text) => {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = text;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    };

    const urlParams = new URLSearchParams(window.location.search);
    const serverId = urlParams.get("id");

    async function loadServer() {
      const { data, error } = await client.from("servers").select("*").eq("id", serverId).single();
      if (error || !data) {
        serverContainer.innerHTML = `<div style="padding:2rem;text-align:center">Server not found.</div>`;
        return;
      }

      const { name, description, banner, logo, tags, members } = data;

      serverContainer.innerHTML = `
        <div class="banner" style="background-image: url('${banner}')">
          <div class="logo" style="background-image: url('${logo}')"></div>
        </div>
        <div class="content">
          <div class="title">${name}</div>
          <div class="members">${members.toLocaleString()} members</div>
          <div class="description">${description}</div>
          <div class="tags">
            ${tags.map(t => `<span class="tag">${t}</span>`).join(" ")}
          </div>
          <div class="buttons">
            <div class="button" onclick="upvoteServer('${serverId}')">üëç Upvote</div>
            <div class="button danger" onclick="reportServer('${serverId}')">üö® Report</div>
          </div>
          <div class="comments">
            <div class="comment-box">
              <textarea id="commentText" placeholder="@mention users or servers..." rows="3"></textarea>
              <div class="button" onclick="postComment('${serverId}')">üí¨ Comment</div>
            </div>
            <div id="commentList"></div>
          </div>
        </div>
      `;
      loadComments(serverId);
    }

    async function upvoteServer(id) {
      const { data: { session } } = await client.auth.getSession();
      if (!session) return showToast("Please login to vote");
      const { error } = await client.from("votes").insert({ server_id: id, user_id: session.user.id });
      if (error) return showToast("Already voted!");
      showToast("Thanks for your upvote!");
    }

    async function reportServer(id) {
      const { data: { session } } = await client.auth.getSession();
      if (!session) return showToast("Login to report.");
      await client.from("reports").insert({ server_id: id, user_id: session.user.id, reason: "User report" });
      showToast("Server reported.");
    }

    async function postComment(id) {
      const { data: { session } } = await client.auth.getSession();
      const content = document.getElementById("commentText").value;
      if (!session) return showToast("Login to comment");
      if (!content.trim()) return showToast("Comment is empty");
      await client.from("comments").insert({ server_id: id, user_id: session.user.id, content });
      document.getElementById("commentText").value = "";
      showToast("Comment posted");
      loadComments(id);
    }

    async function loadComments(id) {
      const { data, error } = await client.from("comments").select("*, user_id").eq("server_id", id).order("created_at", { ascending: false });
      const commentList = document.getElementById("commentList");
      commentList.innerHTML = "";
      data?.forEach(comment => {
        const el = document.createElement("div");
        el.className = "comment";
        el.innerHTML = `
          <div class="meta">${new Date(comment.created_at).toLocaleString()}</div>
          <div>${comment.content.replace(/@(\w+)/g, '<span style="color: var(--primary)">@$1</span>')}</div>
          <div style="margin-top:5px"><a href="#" onclick="deleteComment('${comment.id}')" style="font-size:0.8rem;color:var(--danger)">Delete</a></div>
        `;
        commentList.appendChild(el);
      });
    }

    function parseMentions(text) {
  return text.replace(/@([\w\s#-]+)/g, (match, name) => {
    const server = allServers.find(s => s.name.toLowerCase() === name.toLowerCase());
    if (server) {
      return `<a class="mention" href="server.html?id=${server.id}">@${name}</a>`;
    }
    return `<span class="mention">@${name}</span>`;
  });
}

    async function deleteComment(commentId) {
      const { data: { session } } = await client.auth.getSession();
      if (!session) return;
      await client.from("comments").delete().eq("id", commentId);
      showToast("Comment deleted");
      loadComments(serverId);
    }

    let mentionDropdown = document.getElementById("mentionDropdown");
let commentInput = document.getElementById("commentInput");

let allServers = [];
let allUsers = [];

async function fetchMentionsData() {
  const { data: servers } = await supabase.from("servers").select("id, name");
  const { data: users } = await supabase.auth.admin.listUsers(); // requires service role key if using outside dashboard
  allServers = servers || [];
  allUsers = (users?.users || []).map(u => ({
    id: u.id,
    name: u.user_metadata?.full_name || "Unknown User"
  }));
}

fetchMentionsData();

commentInput.addEventListener("input", () => {
  const text = commentInput.value;
  const cursorPos = commentInput.selectionStart;
  const lastAt = text.lastIndexOf("@", cursorPos - 1);

  if (lastAt === -1) {
    mentionDropdown.style.display = "none";
    return;
  }

  const partial = text.slice(lastAt + 1, cursorPos).toLowerCase();
  if (!partial) {
    mentionDropdown.style.display = "none";
    return;
  }

  const matches = [
    ...allServers.filter(s => s.name.toLowerCase().includes(partial)).map(s => ({
      type: "server",
      name: s.name,
      id: s.id
    })),
    ...allUsers.filter(u => u.name.toLowerCase().includes(partial)).map(u => ({
      type: "user",
      name: u.name,
      id: u.id
    }))
  ].slice(0, 5); // limit to 5 matches

  if (matches.length === 0) {
    mentionDropdown.style.display = "none";
    return;
  }

  // position dropdown under textarea
  const rect = commentInput.getBoundingClientRect();
  mentionDropdown.style.left = rect.left + "px";
  mentionDropdown.style.top = (rect.bottom + window.scrollY) + "px";
  mentionDropdown.style.display = "block";
  mentionDropdown.innerHTML = matches
    .map(m => `<div data-type="${m.type}" data-id="${m.id}" data-name="${m.name}">@${m.name}</div>`)
    .join("");
});

// click to insert mention
mentionDropdown.addEventListener("click", e => {
  const target = e.target;
  if (!target.dataset.name) return;

  const cursorPos = commentInput.selectionStart;
  const text = commentInput.value;
  const lastAt = text.lastIndexOf("@", cursorPos - 1);
  const before = text.slice(0, lastAt);
  const after = text.slice(cursorPos);

  const mentionText = `@${target.dataset.name} `;
  commentInput.value = before + mentionText + after;
  commentInput.focus();
  commentInput.selectionStart = commentInput.selectionEnd = before.length + mentionText.length;

  mentionDropdown.style.display = "none";
});


    loadServer();
  </script>
</body>
</html>
